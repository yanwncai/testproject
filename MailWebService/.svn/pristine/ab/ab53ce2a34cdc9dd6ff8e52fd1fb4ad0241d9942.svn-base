/** 
* 2015年8月3日 
* MailWebServiceImpl.java * author:ywc */ 
package com.wondersgroup.mail.ws.impl;  

import java.util.*;

import javax.jws.WebService;

import com.wondersgroup.mail.service.MailSenderInfo;
import com.wondersgroup.mail.service.SimpleMailSender;
import com.wondersgroup.mail.ws.MailWebService;

public class MailWebServiceImpl implements MailWebService {
			
	static Map<String, MailSenderInfo> msiMap;
	static{
		//List<MailSenderInfo> msiList=new ArrayList<MailSenderInfo>();
		msiMap=new HashMap<String, MailSenderInfo>();
		ResourceBundle rb=ResourceBundle.getBundle("mailconfig");
		//获取群组数量
		int groupCount=Integer.parseInt(rb.getString("groupCount"));
		if(groupCount>0){
			for(int i=1;i<=groupCount;i++){
				MailSenderInfo msi=new MailSenderInfo();
				msi.setUserName(rb.getString("username"+i));
				msi.setPassword(rb.getString("password"+i));
				msi.setMailServerHost(rb.getString("MailServerHost"+i));
				msi.setMailServerPort(rb.getString("MailServerPort"+i));
				msi.setFromAddress(rb.getString("sendAddr"+i));
				msi.setSubject(rb.getString("Subject"+i));
				String toAddress=rb.getString("toAddress1");
				String[] toAddressArray=toAddress.split(",");
				List<String> listToAddress=new ArrayList<String>();
				for(int j=0;j<toAddressArray.length;j++){
					String Address=toAddressArray[j];
					listToAddress.add(Address);
				}
				msi.setToAddress(listToAddress);
				msiMap.put(rb.getString("groupName"+i), msi);
			}
		}
		System.out.println("test");
	}
	
	
	/**
	 * mailContent 邮件内容
	 * groupKey 邮件需要发送的群组
	 */
	@Override
	public String sendEmail(String mailContent,String groupKey) {
		String msg="发送成功";
		
		MailSenderInfo msi=msiMap.get(groupKey);
		if(msi!=null){
			msi.setContent(mailContent);
		}else{
			return "{isSended:0,msg:服务器端获取msi对象失败}";
		}
		SimpleMailSender sms=new SimpleMailSender();
		boolean isOk=true;
		try {
			isOk = sms.sendHtmlMail(msi);
			System.out.println("发送状态："+(isOk==true?"{isSended:1,msg:"+msg+"}":"{isSended:0,msg:发送失败}"));
			return isOk==true?"{isSended:1,msg:"+msg+"}":"{isSended:0,msg:发送失败}";
		} catch (Exception e) {
			e.printStackTrace();
			return "{isSended:0,msg:发送失败}";
		}
		
	}
}
 